{"version":3,"file":"index.js","sources":["../src/nep9.js","../src/cache-promise.js","../src/qrcode.js","../src/index.js"],"sourcesContent":["// import {wallet} from '@cityofzion/neon-js';\n\nexport function generateUri(address, properties) {\n\t// if (!address || !wallet.isAddress(address)) {\n\tif (!address) {\n  \treturn;\n\t}\n\n\tlet output = `neo:${address}`\n\tif (properties) {\n\t\toutput += serializeQuery(properties);\n\t}\n\n  return output;\n}\n\nfunction serializeQuery(query) {\n\n\tconst parameters = Object.keys(query).reduce((accum, key) => {\n    const value = query[key];\n    accum.push(`${key}=${value}`);\n    return accum;\n  }, []);\n\n\treturn parameters.length ? `?${parameters.join('&')}` : '';\n}\n","import lruCache from 'lru-cache';\n\nexport const STATUS = {\n  initialized: 'initialized',\n  fetching: 'fetching',\n  fetched: 'fetched',\n  fetchFailed: 'fetch failed',\n};\n\nexport class CacheItem {\n  constructor(opts) {\n    this.key = opts.key;\n    this.value = opts.value;\n    this.fetchFunction = opts.fetchFunction;\n    this.init();\n  }\n\n  init(status = STATUS.initialized) {\n    this.status = status;\n    this.resolvers = [];\n    this.rejectors = [];\n    return this.rejectors;\n  }\n\n  fetch() {\n    return Promise.resolve().then(() => {\n      if (this.status === STATUS.fetchFailed) {\n        this.init();\n      }\n      if (this.status === STATUS.fetched || !this.fetchFunction) {\n        // Return the current value\n        return this.value;\n      }\n      // Add a promise to the list of promises awaiting fetch completion\n      const p = new Promise((resolve, reject) => {\n        this.resolvers.push(resolve);\n        return this.rejectors.push(reject);\n      });\n      if (this.status === STATUS.initialized) {\n        // Call the fetch function\n        this.status = STATUS.fetching;\n        Promise.resolve().then(() => this.fetchFunction(this.key)).then((value) => {\n          this.value = value;\n          this.status = STATUS.fetched;\n          const ref = this.resolvers;\n          const results = [];\n          for (let i = 0, len = ref.length; i < len; i++) {\n            const r = ref[i];\n            results.push(r(value));\n          }\n          this.init(this.status);\n          return results;\n        }).catch((err) => {\n          this.status = STATUS.fetchFailed;\n          const ref = this.rejectors;\n          const results = [];\n          for (let i = 0, len = ref.length; i < len; i++) {\n            const r = ref[i];\n            results.push(r(err));\n          }\n          this.init(this.status);\n          return results;\n        });\n      }\n      return p;\n    });\n  }\n}\n\nexport default function (opts) {\n  const cache = lruCache(opts);\n  cache.getAsync = function getAsync(key, fetchFunction) {\n    let item;\n    item = cache.get(key);\n    if (item === undefined && fetchFunction) {\n      // Create a new cache item\n      item = new CacheItem({\n        key,\n        fetchFunction,\n      });\n      cache.set(key, item);\n    }\n    if (!(item instanceof CacheItem)) {\n      return Promise.resolve(item);\n    }\n    return item.fetch();\n  };\n  return cache;\n}\n","import Jimp from 'jimp';\nimport dataUriToBuffer from 'data-uri-to-buffer';\nimport QRCode from 'qrcode';\nimport path from 'path';\nimport cachePromise from './cache-promise';\n\nfunction createImageFromDataUri(dataUri) {\n  return new Promise((resolve) => {\n    new Jimp(dataUriToBuffer(dataUri), (err, img) => {\n      if (err) throw err;\n      resolve(img);\n    });\n  });\n}\n\nfunction createQRCode(uri, options) {\n  // FIXME: it works. But it could be more efficient.\n  // The npm qrcode module cannot output just a buffer.\n  // So we need to pass through base64 encoding.\n  // To fix this, we need to create a PR on qrcode to support output as a buffer.\n  return new Promise(resolve => {\n    QRCode.toDataURL(uri, options, (err, response) => {\n      if (err) throw err;\n      resolve(createImageFromDataUri(response));\n    });\n  });\n}\n\nexport const cacheLogo = cachePromise();\nexport const cacheLogoResized = cachePromise();\n\nfunction fetchLogo(_logoPath, isLocal) {\n  if (isLocal) {\n    _logoPath = _logoPath[0] === '/' || _logoPath[0] === '\\\\' ? _logoPath : path.resolve(__dirname, _logoPath);\n  }\n  return Jimp.read(_logoPath);\n}\n\nfunction resizeSquared(img, _w, _h) {\n  let w;\n  let h;\n\n  if (_h > _w) {\n    w = Jimp.AUTO;\n    h = _h;\n  } else {\n    w = _w;\n    h = Jimp.AUTO;\n  }\n  return img.resize(w, h);\n}\n\nfunction getResizedLogo({\n  src, w, h, ignoreCache = false, isLocal\n}) {\n  if (ignoreCache) {\n    return fetchLogo(src, isLocal).then(img => resizeSquared(img, w, h));\n  }\n\n  const resizedLogoKey = `${w}x${h}-${src}`;\n  return cacheLogoResized.getAsync(resizedLogoKey, async () => {\n    const logoFullImg = await cacheLogo.getAsync(src, () => fetchLogo(src, isLocal));\n    return resizeSquared(logoFullImg.clone(), w, h);\n  });\n}\n\nexport default function generate({uri, logoUrl, qrCodeOptions, ratio}) {\n  console.log('generate')\n  return createQRCode(uri, qrCodeOptions)\n  .then(img => {\n    console.log('createQRCode')\n    return Promise.all([\n      img,\n      getResizedLogo({\n        src: './assets/blankSquare.png',\n        w: Math.floor(img.bitmap.width / (ratio - 0.5)),\n        h: Math.floor(img.bitmap.height / (ratio - 0.5)),\n        isLocal: true,\n      }),\n      getResizedLogo({\n        src: logoUrl,\n        w: Math.floor(img.bitmap.width / ratio),\n        h: Math.floor(img.bitmap.height / ratio),\n      }),\n    ])\n  })\n  .then(data => {\n    console.log('getResizedLogo & getResizedLogo')\n    const img = data[0]\n    const logoBg = data[1]\n    const logo = data[2]\n    // Center the logo bg\n    const x_bg = Math.floor((img.bitmap.width - logoBg.bitmap.width) / 2);\n    const y_bg = Math.floor((img.bitmap.height - logoBg.bitmap.height) / 2);\n\n    const qrBgImg = img.composite(logoBg, x_bg, y_bg);\n\n    // Center the logo\n    const x = Math.floor((img.bitmap.width - logo.bitmap.width) / 2);\n    const y = Math.floor((img.bitmap.height - logo.bitmap.height) / 2);\n\n    // Apply on the QRCode\n    const qrImg = qrBgImg.composite(logo, x, y);\n\n    return new Promise((resolve, reject) => {\n      console.log('getBuffer before')\n      qrImg.getBuffer(Jimp.MIME_PNG, (err, buf) => {\n        console.log('getBuffer after')\n        if (err) return rej(err);\n        console.log('getBuffer fine')\n        return resolve(buf);\n      });\n    });\n  });\n}\n","import { generateUri } from './nep9';\nimport generateQrCode from './qrcode';\n\nmodule.exports = {\n  generateUri,\n  generateQrCode\n}\n"],"names":["generateUri","address","properties","output","serializeQuery","query","parameters","Object","keys","reduce","accum","key","value","push","length","join","STATUS","CacheItem","opts","fetchFunction","init","status","initialized","resolvers","rejectors","Promise","resolve","then","fetchFailed","fetched","p","reject","fetching","ref","results","i","len","r","catch","err","cache","lruCache","getAsync","item","get","undefined","set","fetch","createImageFromDataUri","dataUri","Jimp","dataUriToBuffer","img","createQRCode","uri","options","toDataURL","response","cacheLogo","cachePromise","cacheLogoResized","fetchLogo","_logoPath","isLocal","path","__dirname","read","resizeSquared","_w","_h","w","h","AUTO","resize","getResizedLogo","src","ignoreCache","resizedLogoKey","logoFullImg","clone","generate","logoUrl","qrCodeOptions","ratio","log","all","Math","floor","bitmap","width","height","data","logoBg","logo","x_bg","y_bg","qrBgImg","composite","x","y","qrImg","getBuffer","MIME_PNG","buf","rej","module","exports"],"mappings":"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"}