{"version":3,"file":"index.js","sources":["../src/nep9.js","../src/cache-promise.js","../src/qrcode.js","../src/index.js"],"sourcesContent":["// import {wallet} from '@cityofzion/neon-js';\n\nexport function generateUri(address, properties) {\n\t// if (!address || !wallet.isAddress(address)) {\n\tif (!address) {\n  \treturn;\n\t}\n\n\tlet output = `neo:${address}`\n\tif (properties) {\n\t\toutput += serializeQuery(properties);\n\t}\n\n  return output;\n}\n\nfunction serializeQuery(query) {\n\n\tconst parameters = Object.keys(query).reduce((accum, key) => {\n    const value = query[key];\n    accum.push(`${key}=${value}`);\n    return accum;\n  }, []);\n\n\treturn parameters.length ? `?${parameters.join('&')}` : '';\n}\n","import lruCache from 'lru-cache';\n\nexport const STATUS = {\n  initialized: 'initialized',\n  fetching: 'fetching',\n  fetched: 'fetched',\n  fetchFailed: 'fetch failed',\n};\n\nexport class CacheItem {\n  constructor(opts) {\n    this.key = opts.key;\n    this.value = opts.value;\n    this.fetchFunction = opts.fetchFunction;\n    this.init();\n  }\n\n  init(status = STATUS.initialized) {\n    this.status = status;\n    this.resolvers = [];\n    this.rejectors = [];\n    return this.rejectors;\n  }\n\n  fetch() {\n    return Promise.resolve().then(() => {\n      if (this.status === STATUS.fetchFailed) {\n        this.init();\n      }\n      if (this.status === STATUS.fetched || !this.fetchFunction) {\n        // Return the current value\n        return this.value;\n      }\n      // Add a promise to the list of promises awaiting fetch completion\n      const p = new Promise((resolve, reject) => {\n        this.resolvers.push(resolve);\n        return this.rejectors.push(reject);\n      });\n      if (this.status === STATUS.initialized) {\n        // Call the fetch function\n        this.status = STATUS.fetching;\n        Promise.resolve().then(() => this.fetchFunction(this.key)).then((value) => {\n          this.value = value;\n          this.status = STATUS.fetched;\n          const ref = this.resolvers;\n          const results = [];\n          for (let i = 0, len = ref.length; i < len; i++) {\n            const r = ref[i];\n            results.push(r(value));\n          }\n          this.init(this.status);\n          return results;\n        }).catch((err) => {\n          this.status = STATUS.fetchFailed;\n          const ref = this.rejectors;\n          const results = [];\n          for (let i = 0, len = ref.length; i < len; i++) {\n            const r = ref[i];\n            results.push(r(err));\n          }\n          this.init(this.status);\n          return results;\n        });\n      }\n      return p;\n    });\n  }\n}\n\nexport default function (opts) {\n  const cache = lruCache(opts);\n  cache.getAsync = function getAsync(key, fetchFunction) {\n    let item;\n    item = cache.get(key);\n    if (item === undefined && fetchFunction) {\n      // Create a new cache item\n      item = new CacheItem({\n        key,\n        fetchFunction,\n      });\n      cache.set(key, item);\n    }\n    if (!(item instanceof CacheItem)) {\n      return Promise.resolve(item);\n    }\n    return item.fetch();\n  };\n  return cache;\n}\n","import Jimp from 'jimp';\nimport dataUriToBuffer from 'data-uri-to-buffer';\nimport QRCode from 'qrcode';\nimport path from 'path';\nimport cachePromise from './cache-promise';\n\nfunction createImageFromDataUri(dataUri) {\n  return new Promise((resolve) => {\n    new Jimp(dataUriToBuffer(dataUri), (err, img) => {\n      if (err) throw err;\n      resolve(img);\n    });\n  });\n}\n\nfunction createQRCode(uri, options) {\n  // FIXME: it works. But it could be more efficient.\n  // The npm qrcode module cannot output just a buffer.\n  // So we need to pass through base64 encoding.\n  // To fix this, we need to create a PR on qrcode to support output as a buffer.\n  return new Promise(resolve => {\n    QRCode.toDataURL(uri, options, (err, response) => {\n      if (err) throw err;\n      resolve(createImageFromDataUri(response));\n    });\n  });\n}\n\nexport const cacheLogo = cachePromise();\nexport const cacheLogoResized = cachePromise();\n\nfunction fetchLogo(_logoPath, isLocal) {\n  if (isLocal) {\n    _logoPath = _logoPath[0] === '/' || _logoPath[0] === '\\\\' ? _logoPath : path.resolve(__dirname, _logoPath);\n  }\n  return Jimp.read(_logoPath);\n}\n\nfunction resizeSquared(img, _w, _h) {\n  let w;\n  let h;\n\n  if (_h > _w) {\n    w = Jimp.AUTO;\n    h = _h;\n  } else {\n    w = _w;\n    h = Jimp.AUTO;\n  }\n  return img.resize(w, h);\n}\n\nfunction getResizedLogo({\n  src, w, h, ignoreCache = false, isLocal\n}) {\n  console.log('getResizedLogo')\n  if (ignoreCache) {\n    return fetchLogo(src, isLocal).then(img => resizeSquared(img, w, h));\n  }\n  console.log('getResizedLogo, ignoreCache')\n  const resizedLogoKey = `${w}x${h}-${src}`;\n  return cacheLogoResized.getAsync(resizedLogoKey, async () => {\n    console.log('getResizedLogo, cacheLogoResized')\n    const logoFullImg = await cacheLogo.getAsync(src, () => fetchLogo(src, isLocal));\n    console.log('getResizedLogo, logoFullImg')\n    return resizeSquared(logoFullImg.clone(), w, h);\n  });\n}\n\nexport default function generate({uri, logoUrl, qrCodeOptions, ratio}) {\n  // console.log('generate')\n  // return createQRCode(uri, qrCodeOptions)\n  // .then(img => {\n  //   console.log('createQRCode')\n  //   return Promise.all([\n  //     img,\n  //     getResizedLogo({\n  //       src: '../assets/blankSquare.png',\n  //       w: Math.floor(img.bitmap.width / (ratio - 0.5)),\n  //       h: Math.floor(img.bitmap.height / (ratio - 0.5)),\n  //       isLocal: true,\n  //     }),\n  //     getResizedLogo({\n  //       src: logoUrl,\n  //       w: Math.floor(img.bitmap.width / ratio),\n  //       h: Math.floor(img.bitmap.height / ratio),\n  //     }),\n  //   ])\n  //   .catch(err => {\n  //     console.log('Promise.all', err)\n  //     throw err\n  //   })\n  // })\n  // .then(data => {\n  //   console.log('getResizedLogo & getResizedLogo')\n  //   const img = data[0]\n  //   const logoBg = data[1]\n  //   const logo = data[2]\n  //   // Center the logo bg\n  //   const x_bg = Math.floor((img.bitmap.width - logoBg.bitmap.width) / 2);\n  //   const y_bg = Math.floor((img.bitmap.height - logoBg.bitmap.height) / 2);\n  //\n  //   const qrBgImg = img.composite(logoBg, x_bg, y_bg);\n  //\n  //   // Center the logo\n  //   const x = Math.floor((img.bitmap.width - logo.bitmap.width) / 2);\n  //   const y = Math.floor((img.bitmap.height - logo.bitmap.height) / 2);\n  //\n  //   // Apply on the QRCode\n  //   const qrImg = qrBgImg.composite(logo, x, y);\n  //\n  //   return new Promise((resolve, reject) => {\n  //     console.log('getBuffer before')\n  //     qrImg.getBuffer(Jimp.MIME_PNG, (err, buf) => {\n  //       console.log('getBuffer after')\n  //       if (err) return rej(err);\n  //       console.log('getBuffer fine')\n  //       return resolve(buf);\n  //     });\n  //   });\n  // });\n\n  return Jimp.read(logoUrl)\n  .then(img => {\n    img.getBuffer(Jimp.MIME_PNG, (err, buf) => {\n      if (err) return rej(err);\n      return resolve(buf);\n    });\n  })\n}\n","import { generateUri } from './nep9';\nimport generateQrCode from './qrcode';\n\nmodule.exports = {\n  generateUri,\n  generateQrCode\n}\n"],"names":["generateUri","address","properties","output","serializeQuery","query","parameters","Object","keys","reduce","accum","key","value","push","length","join","STATUS","CacheItem","opts","fetchFunction","init","status","initialized","resolvers","rejectors","Promise","resolve","then","fetchFailed","fetched","p","reject","fetching","ref","results","i","len","r","catch","err","cache","lruCache","getAsync","item","get","undefined","set","fetch","cacheLogo","cachePromise","cacheLogoResized","generate","uri","logoUrl","qrCodeOptions","ratio","Jimp","read","img","getBuffer","MIME_PNG","buf","rej","module","exports"],"mappings":"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"}